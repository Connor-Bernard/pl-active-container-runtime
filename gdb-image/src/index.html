<!doctype html>
<html lang="en">

<head>
  <link rel="stylesheet" href="xterm/css/xterm.css" />
  <script src="xterm/lib/xterm.js"></script>
  <script src="xterm-fit/lib/xterm-addon-fit.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #banner {
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 1px solid #ccc;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }

    #mission-container {
      padding: 10px;
      background-color: #e0e0e0;
      border-bottom: 1px solid #ccc;
    }

    #terminal-container {
      flex-grow: 1;
    }

    #mission-description {
      margin-top: 10px;
      font-style: italic;
    }
  </style>
</head>

<body>
  <div id="banner"></div>
  <div id="mission-container">
    <h3>Current Mission: <span id="mission-number"></span></h3>
    <p id="mission-instruction"></p>
    <p id="mission-description"></p>
  </div>
  <div id="terminal-container"></div>
  <script>
    const term = new Terminal();
    const fit = new FitAddon.FitAddon();
    term.loadAddon(fit);
    term.open(document.getElementById('terminal-container'));
    fit.fit();

    const socket = new WebSocket(`ws://${window.location.host}${window.location.pathname}`);

    socket.onopen = () => {
      term.onData((data) => {
        socket.send(JSON.stringify({ event: 'data', value: data }));
      });
      term.onResize(() => {
        fit.fit();
        socket.send(JSON.stringify({ event: 'resize', value: { cols: term.cols, rows: term.rows } }));
      });
      window.addEventListener('resize', () => fit.fit());
    };

    socket.onmessage = (ev) => {
      const message = JSON.parse(ev.data);
      switch (message.type) {
        case 'output':
          term.write(message.data);
          break;
        case 'banner':
          document.getElementById('banner').textContent = message.data;
          break;
        case 'init':
        case 'mission_complete':
          document.getElementById('mission-number').textContent = `Step ${message.currentMission + 1}`;
          document.getElementById('mission-instruction').textContent = message.instruction;
          document.getElementById('mission-description').textContent = message.description;
          if (message.type === 'mission_complete') {
            term.write('\r\nðŸŽ‰ Mission complete! Moving to next task.\r\n');
          }
          break;
      }
    };

    setInterval(() => {
      if (socket.readyState === 1) {
        socket.send(JSON.stringify({ event: 'heartbeat' }));
      }
    }, 60000);
  </script>
</body>

</html>